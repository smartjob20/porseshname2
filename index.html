<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ارزیابی کیفیت خواب | WebLegend</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root { --bg: #f3f4f6; --primary: #4f46e5; --text: #1f2937; --white: #ffffff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .app-container { background: var(--white); width: 100%; max-width: 700px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; position: relative; margin-top: 20px; margin-bottom: 20px;}
        .header { background: linear-gradient(135deg, var(--primary), #3730a3); padding: 25px; text-align: center; color: white; }
        .header h1 { margin: 0; font-size: 1.4rem; }
        .progress-bar { height: 6px; background: #e0e7ff; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #818cf8; width: 0%; transition: width 0.3s; }
        .step-content { padding: 25px; display: none; }
        .step-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.95rem; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit; font-size: 1rem; }
        input:focus { border-color: var(--primary); background: #fdfdfd; }
        .time-box { display: flex; gap: 10px; align-items: center; }
        .time-select { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; font-family: inherit; font-size: 1rem; }
        .radio-list { display: grid; gap: 10px; }
        .radio-item { position: relative; }
        .radio-item input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
        .radio-view { display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; transition: 0.2s; }
        .radio-item input:checked + .radio-view { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: bold; }
        .circle { width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; margin-left: 10px; }
        .radio-item input:checked + .radio-view .circle { background: var(--primary); border-color: var(--primary); }
        .footer { padding: 20px 25px; border-top: 1px solid #eee; display: flex; justify-content: space-between; background: #f9fafb; }
        button { padding: 12px 25px; border-radius: 10px; border: none; font-size: 1rem; cursor: pointer; font-family: inherit; }
        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: transparent; border: 2px solid #ddd; color: #555; }
        #error-msg { color: red; text-align: center; margin-top: 10px; font-weight: bold; font-size: 0.9rem; display: none; }
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">
        <h1>پرسش‌نامه خواب PSQI</h1>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    </div>
    <form id="mainForm" onsubmit="return false;">
        <div class="step-content active" id="step1">
            <div class="input-group"><label>نام و نام خانوادگی:</label><input type="text" id="name" placeholder="مثلاً: علی رضایی"></div>
            <div class="input-group"><label>سن:</label><input type="number" id="age" placeholder="مثلاً: 25"></div>
        </div>
        <div class="step-content" id="step2">
            <div class="input-group"><label>۱. ساعت رفتن به رختخواب:</label><div class="time-box" id="box-q1"></div></div>
            <div class="input-group"><label>۲. مدت زمان تا به خواب رفتن (دقیقه):</label><input type="number" id="q2" placeholder="مثلاً 30"></div>
            <div class="input-group"><label>۳. ساعت بیدار شدن در صبح:</label><div class="time-box" id="box-q3"></div></div>
            <div class="input-group"><label>۴. مدت خواب واقعی (ساعت):</label><input type="number" id="q4" placeholder="مثلاً 7.5"></div>
        </div>
        <div class="step-content" id="step3">
            <p style="text-align:center; font-weight:bold; color:#4f46e5;">در ماه گذشته، چقدر این مشکلات را داشته‌اید؟</p>
            <div id="grid-container"></div>
        </div>
        <div class="step-content" id="step4">
            <div class="input-group"><label>۶. کیفیت کلی خواب شما؟</label><div class="radio-list" id="opt-q6"></div></div>
            <div class="input-group"><label>۷. مصرف داروی خواب؟</label><div class="radio-list" id="opt-q7"></div></div>
            <div class="input-group"><label>۸. مشکل در بیدار ماندن طی روز؟</label><div class="radio-list" id="opt-q8"></div></div>
            <div class="input-group"><label>۹. بی‌انگیزگی برای کارها؟</label><div class="radio-list" id="opt-q9"></div></div>
        </div>
    </form>
    <div id="error-msg"></div>
    <div class="footer">
        <button type="button" class="btn-prev" id="btnPrev" onclick="prevStep()" style="visibility: hidden;">بازگشت</button>
        <button type="button" class="btn-next" id="btnNext" onclick="nextStep()">مرحله بعد</button>
    </div>
</div>
<script>
    // --- کلیدهای خود را اینجا وارد کنید ---
    const SUPABASE_URL = 'https://nxpvtkbcsdurhyedpfst.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54cHZ0a2Jjc2R1cmh5ZWRwZnN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzg2NzQsImV4cCI6MjA4MTYxNDY3NH0.AB36bVcnufe18fbyd-6NIT7VgYOx0HElZKTt_TRZ0cw';

    const gridQuestions = [
        {id:'q5a', t:'۵-الف) ناتوانی در خوابیدن طی ۳۰ دقیقه'}, {id:'q5b', t:'۵-ب) بیدار شدن در نیمه‌شب یا صبح زود'},
        {id:'q5c', t:'۵-ج) بیدار شدن برای دستشویی'}, {id:'q5d', t:'۵-د) مشکل تنفسی'},
        {id:'q5e', t:'۵-ه) خروپف بلند یا سرفه'}, {id:'q5f', t:'۵-و) احساس سرمای زیاد'},
        {id:'q5g', t:'۵-ز) احساس گرمای زیاد'}, {id:'q5h', t:'۵-ح) دیدن کابوس'}, {id:'q5i', t:'۵-ط) درد فیزیکی'}
    ];
    const optsTime = ['خیر', 'کمتر از ۱ بار/هفته', '۱ یا ۲ بار/هفته', '۳ بار یا بیشتر/هفته'];
    let currentStep = 1; const totalSteps = 4;

    function renderTimePicker(id, prefix) {
        let h = `<select id="${prefix}_h" class="time-select">`; for(let i=0;i<24;i++) h+=`<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</option>`; h+='</select>';
        let m = `<select id="${prefix}_m" class="time-select">`; ['00','15','30','45'].forEach(x=>m+=`<option value="${x}">${x}</option>`); m+='</select>';
        document.getElementById(id).innerHTML = h + '<span style="font-weight:bold; padding:0 5px">:</span>' + m;
    }
    function renderRadios(id, name, options) {
        let html=''; options.forEach((txt,idx)=>{html+=`<div class="radio-item"><input type="radio" name="${name}" value="${idx}"><div class="radio-view"><div class="circle"></div><span>${txt}</span></div></div>`;}); document.getElementById(id).innerHTML=html;
    }
    (function init() {
        renderTimePicker('box-q1','t1'); renderTimePicker('box-q3','t3');
        document.getElementById('grid-container').innerHTML = gridQuestions.map(q=>`<div class="input-group"><label>${q.t}</label><div class="radio-list" id="sub-${q.id}"></div></div>`).join('');
        gridQuestions.forEach(q=>renderRadios(`sub-${q.id}`,q.id,optsTime));
        renderRadios('opt-q6','q6',['بسیار خوب','خوب','تاحدودی بد','بسیار بد']); renderRadios('opt-q7','q7',optsTime); renderRadios('opt-q8','q8',optsTime); renderRadios('opt-q9','q9',optsTime);
    })();
    function showError(msg) { const el=document.getElementById('error-msg'); el.innerText=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); }
    window.nextStep=function(){
        if(!validateStep(currentStep)) return;
        if(currentStep<totalSteps) { document.getElementById(`step${currentStep}`).classList.remove('active'); currentStep++; document.getElementById(`step${currentStep}`).classList.add('active'); updateUI(); } 
        else { submitFinalData(); }
    }
    window.prevStep=function(){ if(currentStep>1){ document.getElementById(`step${currentStep}`).classList.remove('active'); currentStep--; document.getElementById(`step${currentStep}`).classList.add('active'); updateUI(); } }
    function updateUI(){
        document.getElementById('btnPrev').style.visibility=(currentStep===1)?'hidden':'visible';
        document.getElementById('btnNext').innerText=(currentStep===totalSteps)?'ثبت نهایی':'مرحله بعد';
        document.getElementById('progress').style.width=((currentStep-1)/(totalSteps-1)*100)+'%'; window.scrollTo(0,0);
    }
    function validateStep(step){
        if(step===1 && (!document.getElementById('name').value || !document.getElementById('age').value)) { showError('لطفاً نام و سن را وارد کنید!'); return false; }
        if(step===2 && (!document.getElementById('q2').value || !document.getElementById('q4').value)) { showError('لطفاً همه اعداد را وارد کنید!'); return false; }
        return true;
    }
    async function submitFinalData(){
        const btn=document.getElementById('btnNext'); btn.innerText='در حال ارسال...'; btn.disabled=true;
        try {
            if(typeof supabase==='undefined') throw new Error('کتابخانه Supabase لود نشد (VPN چک شود)');
            const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
            const answers={ q1:document.getElementById('t1_h').value+':'+document.getElementById('t1_m').value, q2:Number(document.getElementById('q2').value), q3:document.getElementById('t3_h').value+':'+document.getElementById('t3_m').value, q4:Number(document.getElementById('q4').value), ...getRadVal('q6'), ...getRadVal('q7'), ...getRadVal('q8'), ...getRadVal('q9') };
            gridQuestions.forEach(q=>{ const el=document.querySelector(`input[name="${q.id}"]:checked`); answers[q.id]=el?Number(el.value):0; });
            const {error}=await client.from('psqi_responses').insert({ personal_info:{name:document.getElementById('name').value, age:document.getElementById('age').value}, answers:answers });
            if(error) throw error;
            alert('✅ ثبت شد! خسته نباشید.'); location.reload();
        } catch(err){ alert('❌ خطا: '+err.message); btn.innerText='تلاش مجدد'; btn.disabled=false; }
    }
    function getRadVal(name){ const el=document.querySelector(`input[name="${name}"]:checked`); return {[name]:el?Number(el.value):0}; }
</script>
</body>
</html>